<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï°∞Î≥Ñ Ï†êÏàò ÌòÑÌô©Ìåê</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            margin: 0;
            color: #1e293b;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            text-align: center;
            color: #0f172a;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: -0.05em;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            text-align: center;
            border: 2px solid #f1f5f9;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Rank Styles */
        .rank-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #64748b;
            color: white;
            padding: 6px 16px;
            border-radius: 99px;
            font-size: 0.9rem;
            font-weight: 800;
            margin-bottom: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Top 3 Special Styles */
        .team-card.rank-1 {
            background: linear-gradient(135deg, #fff, #fff9e6);
            border-color: #fbbf24;
            box-shadow: 0 20px 25px -5px rgba(251, 191, 36, 0.15), 0 8px 10px -6px rgba(251, 191, 36, 0.1);
            transform: scale(1.05);
            z-index: 10;
        }

        .team-card.rank-1 .rank-badge {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .team-card.rank-2 {
            background: linear-gradient(135deg, #fff, #f8fafc);
            border-color: #94a3b8;
            box-shadow: 0 20px 25px -5px rgba(148, 163, 184, 0.15), 0 8px 10px -6px rgba(148, 163, 184, 0.1);
            transform: scale(1.02);
            z-index: 5;
        }

        .team-card.rank-2 .rank-badge {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            box-shadow: 0 4px 12px rgba(148, 163, 184, 0.4);
        }

        .team-card.rank-3 {
            background: linear-gradient(135deg, #fff, #fff1f2);
            border-color: #fca5a5;
            box-shadow: 0 20px 25px -5px rgba(252, 165, 165, 0.15), 0 8px 10px -6px rgba(252, 165, 165, 0.1);
            transform: scale(1.02);
            z-index: 5;
        }

        .team-card.rank-3 .rank-badge {
            background: linear-gradient(135deg, #f87171, #b91c1c);
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.4);
        }

        .team-name {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #0f172a;
            letter-spacing: -0.02em;
        }

        .score-info {
            background: rgba(241, 245, 249, 0.5);
            border-radius: 16px;
            padding: 12px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
        }

        .score-row.total-score {
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px dashed #e2e8f0;
        }

        .score-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
        }

        .score-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: #334155;
            font-variant-numeric: tabular-nums;
        }

        .total-score .score-label {
            color: #0f172a;
            font-size: 1rem;
        }

        .total-score .score-value {
            color: #2563eb;
            font-size: 1.8rem;
            line-height: 1;
        }

        /* Rank Icon Animation */
        .rank-icon {
            font-size: 1.1em;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(240, 242, 245, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-weight: bold;
            color: #64748b;
            backdrop-filter: blur(5px);
        }

        /* Responsive resizing */
        @media screen and (max-height: 800px) {
            body {
                zoom: 0.9;
            }
        }

        @media screen and (max-height: 600px) {
            body {
                zoom: 0.75;
            }
        }
    </style>
</head>

<body>

    <div id="loading" class="loading-overlay">
        <div style="text-align: center;">
            <i class="fa-solid fa-circle-notch fa-spin"
                style="font-size: 2rem; margin-bottom: 10px; color: #3b82f6;"></i><br>
            Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
        </div>
    </div>

    <h1>üèÜ Ï°∞Î≥Ñ Ïã§ÏãúÍ∞Ñ Ï†êÏàò ÌòÑÌô©</h1>
    <div class="grid-container" id="score-board">
        <!-- Javascript will insert data here -->
    </div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Config from lseungkyu.github.io/scoreboard
        const firebaseConfig = {
            apiKey: "AIzaSyCxCOVwf1cY7dx1B9Bk0pTIsxww_Bc8qTQ",
            authDomain: "biblequizcloud.firebaseapp.com",
            projectId: "biblequizcloud",
            storageBucket: "biblequizcloud.firebasestorage.app",
            messagingSenderId: "794279182240",
            appId: "1:794279182240:web:63f70343a050513d902ec5"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        const COLLECTION_NAME = "team_scores";
        const TEAM_COUNT = 12;

        const scoreBoard = document.getElementById('score-board');
        const loading = document.getElementById('loading');

        // Initial Layout
        const renderPlaceholder = () => {
            scoreBoard.innerHTML = '';
            for (let i = 1; i <= TEAM_COUNT; i++) {
                const card = document.createElement('div');
                card.className = 'team-card';
                card.id = `team-card-${i}`;
                card.innerHTML = `
                    <div class="rank-badge" id="rank-badge-${i}">
                        <span id="rank-icon-${i}"></span>
                        <span id="rank-text-${i}">-ÏúÑ</span>
                    </div>
                    <div class="team-name">${i}Ï°∞</div>
                    <div class="score-info">
                        <div class="score-row">
                            <span class="score-label">Í∏∞Î≥∏ Ï†êÏàò</span>
                            <span class="score-value" id="unapplied-${i}">0</span>
                        </div>
                        <div class="score-row total-score">
                            <span class="score-label">Ìï©Í≥Ñ</span>
                            <span class="score-value" id="applied-${i}">0</span>
                        </div>
                    </div>
                `;
                scoreBoard.appendChild(card);
            }
        };

        const initApp = async () => {
            renderPlaceholder();

            try {
                // Try to sign in, but don't block if it fails (e.g. local environment issues)
                try {
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously");
                    }
                } catch (authError) {
                    console.warn("Auth failed or skipped (might work if public read is allowed):", authError);
                }

                // Use the correct App ID ("default-app-id" is what the external site uses by default)
                const finalAppId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                console.log(`Connecting to Firestore path: artifacts/${finalAppId}/public/data/${COLLECTION_NAME}/current_game`);

                const docRef = doc(db, 'artifacts', finalAppId, 'public', 'data', COLLECTION_NAME, 'current_game');

                onSnapshot(docRef, (docSnap) => {
                    loading.style.display = 'none';

                    if (!docSnap.exists()) {
                        console.warn("Document does not exist!");
                        return;
                    }

                    const gameData = docSnap.data();

                    // Client-side score calculation logic to match external site
                    const rounds = gameData.rounds || [];

                    // Initialize scores for all teams
                    const teamScores = {};
                    for (let i = 1; i <= TEAM_COUNT; i++) {
                        teamScores[i] = { id: i, baseScore: 0, itemScore: 0, totalScore: 0 };
                    }

                    rounds.forEach(round => {
                        // 1. Base Scores (Winners)
                        const winners = round.winners || [];
                        const points = round.points || 0;
                        winners.forEach(teamId => {
                            if (teamScores[teamId]) {
                                teamScores[teamId].baseScore += points;
                            }
                        });

                        // 2. Process Cards
                        const cards = round.cards || [];
                        const defenses = {};

                        // Identify defenses first (Map: ActorID -> Set of TargetIDs they are defending against)
                        // Note: External site logic implies targeted defense blocks specific attacks.
                        cards.forEach(card => {
                            if (card.cardType === 'defense') {
                                if (!defenses[card.teamId]) defenses[card.teamId] = new Set();
                                if (card.targetId) defenses[card.teamId].add(Number(card.targetId));
                            }
                        });

                        // Apply card effects
                        cards.forEach(card => {
                            const actorId = Number(card.teamId);
                            const targetId = Number(card.targetId);
                            const val = Number(card.value) || 0;

                            if (card.cardType === 'plus') {
                                // Plus adds to the actor (self-buff)
                                if (teamScores[actorId]) teamScores[actorId].itemScore += val;
                            } else if (card.cardType === 'attack') {
                                // Attack subtracts from target
                                if (teamScores[targetId]) {
                                    // Check defense: Does target have a defense against actor?
                                    const hasDefense = defenses[targetId] && defenses[targetId].has(actorId);
                                    if (!hasDefense) {
                                        teamScores[targetId].itemScore -= val;
                                        // Note: Usually attacks reduce the target's score.
                                        // If external site shows "Item Delta" as positive while attacks happened, 
                                        // it likely means the attacks failed or other pluses outweighed them.
                                    } else {
                                        console.log(`Round ${round.id}: Attack from ${actorId} on ${targetId} blocked by defense.`);
                                    }
                                }
                            }
                            // 'overtake' is complex and observed to be potentially 0 effect in sample, skipping for safety
                        });
                    });

                    // Flatten to array for rendering
                    const calculatedStats = [];
                    Object.values(teamScores).forEach(t => {
                        t.totalScore = t.baseScore + t.itemScore;
                        calculatedStats.push(t);
                    });

                    // Calculate Ranks
                    const sortedStats = [...calculatedStats].sort((a, b) => b.totalScore - a.totalScore || a.id - b.id);

                    calculatedStats.forEach((team) => {
                        const teamId = team.id;
                        // Find rank (1-based), handle ties if needed, but simple index for now
                        const rank = sortedStats.findIndex(t => t.id === teamId) + 1;

                        const appliedEl = document.getElementById(`applied-${teamId}`);
                        const unappliedEl = document.getElementById(`unapplied-${teamId}`);
                        const rankTextEl = document.getElementById(`rank-text-${teamId}`);
                        const rankIconEl = document.getElementById(`rank-icon-${teamId}`);
                        const rankBadgeEl = document.getElementById(`rank-badge-${teamId}`);
                        const cardEl = document.getElementById(`team-card-${teamId}`);

                        if (appliedEl) appliedEl.innerText = (team.totalScore || 0).toLocaleString();
                        if (unappliedEl) unappliedEl.innerText = (team.baseScore || 0).toLocaleString();

                        if (rankTextEl) rankTextEl.innerText = `${rank}ÏúÑ`;

                        // Reset Classes
                        if (cardEl) {
                            cardEl.classList.remove('rank-1', 'rank-2', 'rank-3');
                            if (rank <= 3) cardEl.classList.add(`rank-${rank}`);
                        }

                        // Icon Logic
                        if (rankIconEl) {
                            rankIconEl.className = 'rank-icon'; // reset
                            if (rank === 1) rankIconEl.innerHTML = '<i class="fa-solid fa-trophy"></i>';
                            else if (rank === 2) rankIconEl.innerHTML = '<i class="fa-solid fa-medal"></i>';
                            else if (rank === 3) rankIconEl.innerHTML = '<i class="fa-solid fa-medal"></i>';
                            else rankIconEl.innerHTML = '';
                        }
                    });
                }, (error) => {
                    console.error("Snapshot error:", error);
                    loading.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i><br>Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ Ïò§Î•ò<br><span style="font-size:0.8rem">' + error.message + '</span>';
                });

            } catch (error) {
                console.error("Init error:", error);
                loading.innerText = "Ï¥àÍ∏∞Ìôî Ïò§Î•ò: " + error.message;
            }
        };

        initApp();
    </script>
</body>

</html>